<script>

// Fallback (homepage viewing room)
const DEFAULT_EMBED = "https://airtable.com/embed/appd2uoTfbBeo9vI1U/shrGj2FnVG7XsgZ7X";

function getSlug() {

  const params = new URLSearchParams(window.location.search);

  // 1️⃣ Ancien système : ?path=slug
  const pathParam = params.get("path");
  if (pathParam) {
    return decodeURIComponent(pathParam).trim().toLowerCase();
  }

  // 2️⃣ Route normale : /slug
  const path = window.location.pathname
    .replace(/^\/+|\/$/g, "")
    .trim()
    .toLowerCase();

  return path || null;
}

async function load() {

  const params = new URLSearchParams(window.location.search);
  const embedParam = params.get("embed");
  const iframe = document.getElementById("vr");

  if (!iframe) return;

  // 3️⃣ Mode embed direct (ancien système)
  if (embedParam) {
    iframe.src = decodeURIComponent(embedParam);
    return;
  }

  const slug = getSlug();

  // 4️⃣ Homepage = fallback
  if (!slug) {
    iframe.src = DEFAULT_EMBED;
    return;
  }

  // 5️⃣ Chargement slug via API
  try {

    const res = await fetch(`/api/resolve?slug=${encodeURIComponent(slug)}`, {
      cache: "no-store"
    });

    if (!res.ok) throw new Error("Slug not found");

    const data = await res.json();

    iframe.src = data.embed || DEFAULT_EMBED;

  } catch (e) {

    iframe.src = DEFAULT_EMBED;

  }
}

// IMPORTANT → évite les pages blanches
load();

</script>
