<script>
  // Fallback (homepage viewing room)
  const DEFAULT_EMBED = "https://airtable.com/embed/appd2uoTfbeo9v1IU/shrGj2FnVG7XsgZ7XsgZ7X";

  function getSlug() {
    // 1) If coming from 404.html redirect: ?path=slug
    const params = new URLSearchParams(window.location.search);
    const pathParam = params.get("path");
    if (pathParam) return decodeURIComponent(pathParam).trim().toLowerCase();

    // 2) Normal route: /slug
    return window.location.pathname.replace(/^\/+|\/+$/g, "").trim().toLowerCase();
  }

  async function load() {
    const params = new URLSearchParams(window.location.search);
    const embedParam = params.get("embed");
    const iframe = document.getElementById("vr");

    // If explicit embed is provided, always use it
    if (embedParam) {
      iframe.src = decodeURIComponent(embedParam);
      return;
    }

    const slug = getSlug();

    // No slug -> default
    if (!slug) {
      iframe.src = DEFAULT_EMBED;
      return;
    }

    try {
      const r = await fetch(`/api/resolve?slug=${encodeURIComponent(slug)}`, { cache: "no-store" });
      if (!r.ok) throw new Error("Not found");
      const data = await r.json();
      iframe.src = data.embed || DEFAULT_EMBED;
    } catch (e) {
      iframe.src = DEFAULT_EMBED;
    }
  }

  load();
</script>
